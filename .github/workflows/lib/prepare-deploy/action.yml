name: "Prepare environment for deploy"
description: "Prepare environment for deploy"

inputs:
  aws_region:
    description: "AWS Region"
    required: true
  aws_iam_role:
    description: "AWS IAM Role to assume for deployment"
    required: true
  aws_secret_arn:
    description: "AWS Secret ARN to fetch env vars from"
    required: true

runs:
  using: "composite"
  steps:
    - name: Configure AWS Credentials
      # https://github.com/aws-actions/configure-aws-credentials/releases/tag/v4.0.2
      uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502
      with:
        aws-region: ${{ inputs.aws_region }}
        role-to-assume: ${{ inputs.aws_iam_role }}
    - name: Step name
      uses: aws-actions/aws-secretsmanager-get-secrets@v2
      with:
        # The comma before the secret id is to avoid the addition of a prefix to the env vars.
        # See: https://docs.aws.amazon.com/secretsmanager/latest/userguide/retrieving-secrets_github.html#retrieving-secrets_github_alias
        secret-ids: |
          ,${{ inputs.aws_secret_arn }}
        parse-json-secrets: true
    - name: Check env
      shell: bash
      run: |
        env
    # This step recovers the artifact that is generated in the `deploy.yml` workflow
    - name: Download node modules
      # https://github.com/actions/download-artifact/releases/tag/v3.0.2
      uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a
      with:
        name: node_modules
    - name: Unpack node modules
      shell: bash
      run: |
        tar -xf node_modules.tar
    - name: Set up Python and Dependencies
      uses: ./.github/workflows/lib/setup-python
      with:
        python_version: 3.9